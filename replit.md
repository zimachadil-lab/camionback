# CamionBack - Logistics Marketplace Platform

## Overview
CamionBack is a full-stack logistics marketplace web application designed for the Moroccan market. It connects clients requiring transportation services with independent transporters, supporting Client, Transporter, Administrator, and Coordinator roles. The platform aims to streamline logistics operations through features like request creation, service offers, platform management, and operational oversight, with the vision of becoming a leading and efficient logistics solution in Morocco.

## User Preferences
Preferred communication style: Simple, everyday language.

## System Architecture

### UI/UX Decisions
The platform features a mobile-first, dark teal design with a French language interface. It utilizes React 18, TypeScript, Vite, Wouter for routing, TanStack Query for state management, and Tailwind CSS for styling. UI components are built with Shadcn/ui for aesthetics and Radix UI for accessibility, while React Hook Form with Zod manages form states. Key UI elements include responsive role-based navigation, an animated truck header on the login page, Instagram-style stories, a modern role selection page, and an interactive calendar for transporters. PWA enhancements provide offline support, advanced caching, and native-like push notifications. **Transporter Request Cards UX Redesign (Nov 2025):** Completely redesigned request cards for transporters with strong visual hierarchy - prominent route display (XL font), mission date as colored badge, price in vibrant green (3XL font with gradient background), streamlined information layout, and redesigned action buttons with large "Intéressé" button (gradient green, h-14) and discreet "Indisponible" option. Simplified handling/photos info into compact badges, removed "Disponible depuis" timestamp, and made reference ID smaller for cleaner design focused on essential decision-making information. **Client Dashboard Enhancements (Nov 2025):** Completely redesigned "Offres reçues" button with premium blue theme, gradient background, circular icon badge, large counter badge, and responsive mobile layout that prevents overflow. CamioMatch functionality strategically hidden from client UI (kept in system with `{false &&` condition) while maintaining full backend functionality for future reactivation - only "Coordinateur" button visible, now taking full width for maximum visibility.

### Technical Implementations
The backend is an Express.js and TypeScript application providing RESTful JSON APIs. Authentication is phone number-based with 6-digit PIN verification and bcrypt hashing. User roles (Client, Transporter, Admin, Coordinator) define access control. Real-time chat is implemented via WebSockets, and an in-app notification system provides alerts. The application uses PostgreSQL (via Neon Serverless) with Drizzle ORM.

**Key Features:**
- **Request and Offer Workflow:** Multi-status client request progression, transporter offer submission, and acceptance. The workflow has been redesigned to centralize pricing and matching decisions with coordinators, simplifying the transporter's role to expressing interest. **Alternative Availability Dates (Nov 2025):** Transporters can now propose alternative availability dates when expressing interest using a date picker dialog with improved `isSameDay()` comparison (fixes bug where returning to same date still showed "different"). Uses clarified messaging: "✓ Correspond à la date souhaitée par le client" (green) and "ℹ️ Date alternative proposée (acceptable)" (orange) to indicate flexibility is allowed. Date proposals are stored in `transporter_interests` table with `availability_date` field. The "Mes intérêts" tab displays all interests with color-coded badges showing proposed vs. client dates. **Client View Enhancement (Nov 2025):** Clients now see proposed availability dates from interested transporters in the selection dialog, with color-coded badges (green for matching dates, orange for alternatives) to facilitate informed decision-making. Backend enhanced to join `transporter_interests` table in `/api/requests/:requestId/interested-transporters` endpoint. Implemented toggle view (Cartes/Comparaison) allowing clients to switch between traditional card grid view and compact table view for comparing multiple transporters side-by-side with all key information (photo, name, city, rating, availability date, action button) in a single scrollable table. Dialog expanded to max-w-6xl for better comparison experience. **Error Messaging Improvement (Nov 2025):** Enhanced transporter "Indisponible" button error handling to detect 404 errors (deleted requests) and display clear user-friendly message "Cette demande n'est plus disponible" instead of generic error, with automatic cache invalidation to remove stale requests from the UI. **Client Selection Workflow Fix (Nov 2025):** Corrected critical bug where requests validated by clients (when choosing a transporter from interested list) weren't appearing in transporter's "à traiter" dashboard view - fixed by setting `paymentStatus='not_required'` during manual assignment to ensure proper filtering. Added defensive null checks in frontend to prevent "Cannot read properties of undefined" errors when displaying transporter information.
- **User Management:** Transporter rating, contract management, account blocking/deletion, and automated client ID generation with robust race-condition handling. **Transporter Registration Simplification (Nov 2025):** Removed referent/reference system - new transporters now only need to provide basic information (name, city, truck photo) during profile completion, then see a simple "Account pending validation by CamionBack team" message. Account validation is handled directly by admins without requiring professional references.
- **Messaging & Notifications:** Comprehensive multi-channel notification system with in-app, SMS (Infobip), email (Nodemailer), and PWA push notifications for all coordinator-centric workflow events including qualification, publication for matching, transporter interest, archival, and client-transporter contacts. All 12 canonical archive reasons from shared/schema.ts have dedicated French labels for consistent messaging.
- **Admin & Coordinator Tools:** Dynamic dashboards, comprehensive request management (hide/delete/expire/republish, advanced coordination status tracking), reporting, dispute resolution, full CRUD for cities, and automated coordinator assignment. **Admin Dashboard Navigation Restructure (Nov 2025):** Completely rebuilt admin dashboard navigation from overlapping two-row tab system to elegant card-based navigation organized in 3 clear sections: Opérations (7 cards: Demandes, Offres, Contrats, Messages, Paiements, Validation, Retours), Gestion (7 cards: Transporteurs, Clients, Coordinateurs, Statuts Coordination, Signalements, Communications, Facturation), and Configuration (3 cards: Villes, Stories, Statistiques). Removed all Tabs/TabsList/TabsTrigger components and replaced with activeSection state driving conditional rendering. Cards feature animated badges (dual ping+pulse effects), real-time counters, dark teal active ring (#17cfcf), and hover-elevate effects. **KPI Statistics Relocation (Nov 2025):** Moved 4 main KPI cards (Clients actifs, Transporteurs actifs, Demandes totales, Commissions totales) from dashboard header to Configuration → Statistiques section for cleaner navigation layout and better information hierarchy. KPIs displayed in 4-column responsive grid followed by detailed statistics in 3-column grid. E2E tested and verified: no KPIs at dashboard top, all visible in Statistiques with correct values (146 clients, 45 transporteurs, 47 demandes, 60 MAD commissions). **Coordinator Dashboard Restructure (Nov 2025):** Streamlined from 7+ tabs to 4 intuitive views (Nouveau → Qualifiés → En Production → Archives) with unified search bar featuring text, city, status, date, and **coordinator filters**. Implemented client-side filtering with deduplication to prevent duplicate key warnings. Code optimized by ~23% (2750→2100 lines) while maintaining all functionality. **Recent Enhancements (Nov 2025):** Added coordinator attribution display on qualified requests showing "Qualifié par [name]", re-qualification capability via "Requalifier" button for updating pricing on qualified requests without archiving, and coordinator filter in unified search bar for filtering requests by qualifying coordinator. Fixed critical cache invalidation bug where qualified requests weren't appearing in "Qualifiés" view after publication. **Workflow Consistency Fix (Nov 2025):** Corrected automatic coordinationStatus updates when offers are accepted - both client and coordinator acceptance routes now properly set coordinationStatus='assigned' to maintain consistency with manual transporter assignment workflow, ensuring "En Production" view correctly displays all assigned requests. **Visibility Toggle Fix (Nov 2025):** Fixed hide/show functionality in "Qualifiés" view by adding /api/coordinator/matching-requests to React Query cache updates in toggleVisibilityMutation, and activated the feature in "Nouveau" view by enabling showVisibilityToggle parameter, allowing coordinators to hide/show requests from transporters in both qualification stages. **Interested Transporters View (Nov 2025):** Implemented coordinator ability to view detailed list of interested transporters for qualified requests with full contact information (phone, WhatsApp integration) and direct assignment capability using pre-qualified pricing. Uses efficient on-demand data loading via existing `/api/requests/:requestId/interested-transporters` endpoint to avoid N+1 queries. Backend validates numeric inputs to prevent string concatenation bugs in assignment calculations. **Enhanced with Availability Dates & Visibility Control (Nov 2025):** Popup now displays transporter-proposed availability dates with color-coded badges (green "✓ Correspond à la date souhaitée" for dates matching client request, orange "ℹ️ Date alternative" for alternative dates) using isSameDay() comparison with request.dateTime. Added visibility toggle buttons allowing coordinators to hide/unhide interested transporters from client view (Eye/EyeOff icons) - controlled via hiddenFromClient boolean field in transporter_interests table with PATCH endpoint /api/coordinator/toggle-transporter-visibility. Coordinators can now curate which interested transporters are visible to clients, improving match quality and client experience. **Request Republication Feature (Nov 2025):** Coordinators can now republish archived requests directly from the Archives view using a green "Republier" button on each request card. When clicked, the request's status is reset from 'expired' to 'pending', coordinationStatus from 'archive' to 'qualification_pending', and the coordinationReason is cleared. The request immediately appears in the "Nouveau" tab for requalification while disappearing from client's "Terminées" view (expired badge removed). Backend endpoint POST /api/coordinator/requests/:requestId/republish handles the state transitions with automatic client notifications (in-app and push). Frontend mutation invalidates all relevant query caches (qualification-pending, archives, available-requests) ensuring real-time view updates across coordinator and client dashboards.
- **Public Order Sharing:** Coordinators can share transport requests via unique, secure public links with sanitized order details, WhatsApp integration, and direct offer submission for authenticated users.
- **CamioMatch:** An intelligent, Tinder-style transporter matching system for clients.
- **File Management:** Base64 encoding for client photos, Multer for transporter truck photos, and multimedia messaging support.
- **Security:** Comprehensive backend security with 72 protected and sanitized endpoints, session-based authentication using PostgreSQL, HttpOnly/Secure/SameSite cookies, role-based access control, masked phone numbers, and unique tokens for public sharing links exposing only sanitized data. Transporter endpoints use explicit SQL projection to prevent coordinator pricing data leakage (transporterAmount, platformFee, clientTotal, budget fields excluded at query level). E2E security testing validates proper field redaction.
- **PWA Installation:** Dedicated `/app` route for direct PWA installation with platform detection and a contextual installation toast.

### System Design Choices
**Data Storage:** PostgreSQL with Neon serverless and Drizzle ORM.
**Authentication & Authorization:** Phone number-based PIN verification, role, and status-based access control.
**Backend:** Express.js with TypeScript, ES Modules.
**Routing:** Dedicated dashboard routes for Admin, Client, Transporter, and Coordinator.

## External Dependencies

### UI/Styling
- **Radix UI**: Accessible component primitives.
- **Shadcn/ui**: Tailwind-styled components.
- **Lucide React**: Icon library.
- **Tailwind CSS**: Utility-first CSS framework.
- **Embla Carousel**: Carousel/slider.

### Backend Services
- **Infobip API**: SMS notifications.
- **Neon Database**: Serverless PostgreSQL hosting.
- **Nodemailer**: Automated email notifications.
- **Web Push**: Browser push notifications.

### Data Management
- **Drizzle ORM**: Type-safe SQL query builder.
- **Drizzle Zod**: Schema-to-validation generation.
- **TanStack React Query**: Server state management.

### Utilities
- **Wouter**: Lightweight client-side routing.
- **React Hook Form**: Form state management.
- **Zod**: Schema validation.
- **date-fns**: Date manipulation.