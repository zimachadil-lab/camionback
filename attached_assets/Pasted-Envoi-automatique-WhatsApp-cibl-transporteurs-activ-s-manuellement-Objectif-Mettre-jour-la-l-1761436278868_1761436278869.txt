Envoi automatique WhatsApp ciblÃ© (transporteurs activÃ©s manuellement)

Objectif :
Mettre Ã  jour la logique dâ€™envoi automatique de messages WhatsApp pour quâ€™elle ne sâ€™applique quâ€™aux transporteurs activÃ©s manuellement via un bouton â€œWhatsApp ON/OFFâ€ sur la liste des transporteurs validÃ©s.
Le but est de maÃ®triser le volume dâ€™envoi et de privilÃ©gier uniquement les transporteurs les plus fiables et performants.

ğŸ§© 1. Nouvelle icÃ´ne sur la vue Admin / Transporteurs

Sur la vue Admin â†’ Transporteurs, ajouter une nouvelle colonne avec une icÃ´ne WhatsApp (ğŸ’¬).

Cette icÃ´ne agit comme un switch ON/OFF :

ğŸ”µ IcÃ´ne colorÃ©e (turquoise #17cfcf) â†’ activÃ© (le transporteur recevra les messages automatiques WhatsApp).

âšª IcÃ´ne grisÃ©e â†’ dÃ©sactivÃ© (le transporteur est exclu de la liste dâ€™envoi).

Au clic sur lâ€™icÃ´ne :

Mise Ã  jour immÃ©diate du champ is_whatsapp_active (boolean) dans la base de donnÃ©es.

Message visuel : â€œâœ… Transporteur ajoutÃ© Ã  la liste de notification WhatsAppâ€ ou â€œâŒ Transporteur retirÃ© de la listeâ€.

Lâ€™Ã©tat doit Ãªtre persistant en base de donnÃ©es, mÃªme aprÃ¨s dÃ©connexion.

ğŸ§  2. Logique dâ€™envoi des messages

Lorsquâ€™une nouvelle commande est crÃ©Ã©e, le systÃ¨me :

VÃ©rifie les transporteurs validÃ©s ET avec is_whatsapp_active = true.

Pour chaque transporteur actif, envoie le message automatique via le compte WhatsApp Business +212664373534.

Ignore les transporteurs dÃ©sactivÃ©s.

ğŸ’¬ 3. Contenu du message (inchangÃ©, dynamique et structurÃ©)

Exemple du message automatique :

ğŸš› *Nouvelle commande disponible sur CamionBack !*

ğŸ“ Ville de dÃ©part : {{ville_depart}}
ğŸ¯ Ville dâ€™arrivÃ©e : {{ville_arrivee}}
ğŸ—“ï¸ Date souhaitÃ©e : {{date}}
ğŸ’° Prix proposÃ© : {{prix}} MAD
ğŸ“¦ Type de marchandise : {{type_colis}}

ğŸ‘‰ Cliquez ici pour voir la commande :
ğŸ”— {{lien_commande}}

Ne laissez pas votre camion revenir Ã  vide !
ğŸŒ www.camionback.com


Lien dynamique vers la commande : https://camionback.com/commande/{{id}}

Redirection automatique si lâ€™utilisateur nâ€™est pas connectÃ©.

âš™ï¸ 4. Envoi via WhatsApp Business API

Utiliser la session WhatsApp Business dÃ©jÃ  connectÃ©e : +212664373534

Technologie recommandÃ©e : whatsapp-web.js ou Baileys

Connexion persistante avec LocalAuth (QR scannÃ© une seule fois)

Sauvegarde des credentials dans un stockage persistant

Logs dÃ©taillÃ©s Ã  chaque envoi :

âœ… Message envoyÃ© Ã  [Nom transporteur] (+2126...) pour commande CMD-2025-123


Ajouter un petit dÃ©lai (1 message / seconde) pour Ã©viter tout blocage de WhatsApp.

ğŸ§¾ 5. Journalisation (logs et contrÃ´le)

CrÃ©er une table ou un fichier de log whatsapp_notifications :

id_transporteur

numÃ©ro

rÃ©fÃ©rence_commande

date_heure_envoi

status (succÃ¨s / Ã©chec)

Permettre au niveau admin un affichage de lâ€™historique :

Vue optionnelle â€œHistorique WhatsAppâ€ â†’ affichage des envois rÃ©cents.

ğŸ” 6. Gestion et sÃ©curitÃ©

Seuls les transporteurs :

âœ… ValidÃ©s (status = active)

âœ… Avec is_whatsapp_active = true

âœ… NumÃ©ro valide enregistrÃ©
reÃ§oivent le message.

Les autres sont automatiquement ignorÃ©s.

ğŸ§­ 7. AmÃ©lioration UX Admin

Afficher en haut de la liste :

ğŸ”¢ Total transporteurs validÃ©s

ğŸ’¬ Total transporteurs WhatsApp activÃ©s
(ex : â€œTransporteurs activÃ©s pour notifications WhatsApp : 36 / 250â€)

ğŸ’¡ Raison de cette Ã©volution

Lâ€™objectif est dâ€™optimiser les performances et la pertinence des envois :

Ã‰viter le spam vers tous les transporteurs.

Prioriser les plus fiables et performants.

Garder un contrÃ´le total sur le volume.

AmÃ©liorer la qualitÃ© du matching client â†” transporteur.

ğŸ¯ RÃ©sultat attendu

Un bouton simple et clair sur la vue admin (icÃ´ne WhatsApp ON/OFF).

Liste dynamique des transporteurs Ã©ligibles aux notifications automatiques.

Envoi automatique uniquement aux transporteurs sÃ©lectionnÃ©s.

Logs et suivi intÃ©grÃ©s.

SystÃ¨me stable, sans surcharger WhatsApp, et simple Ã  piloter depuis ton tableau de bord.